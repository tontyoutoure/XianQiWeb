# M5 é˜¶æ®µæµ‹è¯•åˆ—è¡¨ï¼ˆç»“ç®—ä¸é‡æ–°å‡†å¤‡ä¸‹ä¸€å±€ï¼‰

> ä¾æ®æ–‡æ¡£ï¼š`memory-bank/implementation-plan.md`ï¼ˆM5ï¼‰ã€`memory-bank/design/engine_design.md`ï¼ˆ4.3ï¼‰ã€`memory-bank/interfaces/backend-engine-interface.md`ï¼ˆ1.5.4ï¼‰ã€`XianQi_rules.md`ï¼ˆç»“ç®—ç­¹ç ï¼‰ã€‚
> å½“å‰èŒƒå›´ï¼šä¿ç•™â€œå¼•æ“ç»“ç®— + engine.cli ç»“ç®—å±•ç¤ºâ€ç»“æœï¼Œå¹¶è¡¥å……åç«¯ `/settlement` ä¸â€œç»“ç®—åé‡æ–° ready å¼€å±€â€çš„æ¥å£æµ‹è¯•æ¸…å•ï¼ˆ`M5-BE-01~10` å·²å®Œæˆ Red->Greenï¼‰ã€‚
> çœŸå®æœåŠ¡æ”¶å£ç´¢å¼•ï¼š`memory-bank/tests/m5-tests-real-service.md`ï¼ˆé¢å‘æœªæ¥å®ç° `M5-RS-REST/WS/CC`ï¼‰ã€‚

## 0) æµ‹è¯•è¿è¡Œç¯å¢ƒä¸æ‰§è¡Œçº¦å®š

- å»ºè®®ç¯å¢ƒï¼šconda `XQB`ã€‚
- å»ºè®®å‘½ä»¤ï¼š
  - å¼•æ“ç»“ç®—ï¼š`conda run -n XQB pytest engine/tests -q`
  - åç«¯æ¥å£ï¼š`conda run -n XQB pytest backend/tests -q`
- æœ¬æ–‡æ¡£ç”¨äºè®°å½• M5 ç”¨ä¾‹è®¾è®¡ä¸æ¯æ¡ç”¨ä¾‹ Red/Green ç»“æœã€‚
- æ ·ä¾‹æ„é€ çº¦æŸï¼šä»»æ„ç»“ç®—æ ·ä¾‹éƒ½å¿…é¡»æ»¡è¶³â€œä¸‰äººæŸ±æ•°æ€»å’Œ `<= 8`â€ï¼ˆ24 å¼ ç‰Œï¼Œæ¯ 3 å¼ ä¸º 1 æŸ±ï¼‰ã€‚
- å¤ç”¨çº¦å®šï¼šM5-UT çš„çŠ¶æ€æ„é€ ã€ç»“ç®—æå–ä¸é€šç”¨å®ˆæ’æ–­è¨€ç»Ÿä¸€å¤ç”¨ `engine/tests/m5_settlement_testkit.py`ã€‚

## 1) å¼•æ“ç»“ç®—æµ‹è¯•ï¼ˆä»… settleï¼‰

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M5-UT-01 | `settle` è°ƒç”¨é˜¶æ®µæ ¡éªŒ | `phase != settlement` è°ƒç”¨ `settle` è¢«æ‹’ç»ï¼›çŠ¶æ€ä¸å˜ã€`version` ä¸å˜ |
| M5-UT-02 | æœ€å°æ­£å¸¸ç»“ç®—ï¼š1å¤Ÿ2æœªå¤Ÿ | æŸ±æ•° `3,2,1` æ—¶ï¼Œä¸¤åæœªå¤Ÿç©å®¶å„å‘å¤Ÿæ£‹ç©å®¶æ”¯ä»˜ 1ï¼›`delta_enough` æ­£ç¡® |
| M5-UT-03 | ç“·æ£‹ç»“ç®—ï¼š1ç“·2æœªå¤Ÿ | æŸ±æ•° `6,2,0` æ—¶ï¼Œä¸¤åæœªå¤Ÿç©å®¶å„å‘ç“·æ£‹ç©å®¶æ”¯ä»˜ 3ï¼›`delta_ceramic` æ­£ç¡® |
| M5-UT-04 | åŒå¤Ÿç»“ç®—ï¼š2å¤Ÿ1æœªå¤Ÿ | æŸ±æ•° `3,3,2` æ—¶ï¼Œæœªå¤Ÿç©å®¶åˆ†åˆ«å‘ä¸¤åå¤Ÿæ£‹ç©å®¶å„æ”¯ä»˜ 1ï¼›å¤Ÿæ£‹ç©å®¶é—´æ— äº’ä»˜ |
| M5-UT-05 | å…¨å‘˜æœªå¤Ÿ | æŸ±æ•° `2,2,2`ï¼ˆæˆ– `0,2,2`ï¼‰ä¸”æ— æ€æ£‹å…³ç³»æ—¶ï¼Œä¸‰äºº `delta` å‡ä¸º 0 |
| M5-UT-06 | å¤Ÿ/ç“·è¾¹ç•Œåˆ¤å®š | è¦†ç›– `2/3/5/6` è¾¹ç•Œï¼ˆå¦‚ `2,3,3`ã€`5,2,1`ã€`6,1,1`ï¼‰ï¼›èº«ä»½åˆ¤å®šåˆ†åˆ«ä¸ºæœªå¤Ÿ/å¤Ÿ/å¤Ÿ/ç“· |
| M5-UT-07 | æ€æ£‹æƒ©ç½šè§¦å‘ | æŸå…³ç³»æ»¡è¶³ `revealer_enough_at_time=false` ä¸”è¯¥ revealer æœ€ç»ˆæœªå¤Ÿæ—¶ï¼Œrevealer å‘ buckler æ”¯ä»˜ 1ï¼ˆ`delta_reveal`ï¼‰ |
| M5-UT-08 | æ€æ£‹æƒ©ç½šä¸è§¦å‘ï¼ˆæœ€ç»ˆå¤Ÿäº†ï¼‰ | `revealer_enough_at_time=false` ä½†è¯¥ revealer æœ€ç»ˆ `pillar>=3` æ—¶ï¼Œè¯¥å…³ç³»ä¸äº§ç”Ÿ `delta_reveal` |
| M5-UT-09 | æ€æ£‹æƒ©ç½šä¸è§¦å‘ï¼ˆæ€æ—¶å·²å¤Ÿï¼‰ | `revealer_enough_at_time=true` æ—¶ï¼Œè¯¥å…³ç³»ä¸äº§ç”Ÿ `delta_reveal` |
| M5-UT-10 | å¤šæ¡æ€æ‰£å…³ç³»ç´¯è®¡ | åŒä¸€ revealer å¤šæ¡æ»¡è¶³æƒ©ç½šæ¡ä»¶å…³ç³»æ—¶ï¼Œ`delta_reveal` æŒ‰æ¡æ•°ç´¯åŠ ï¼Œä¸ä¸¢å¤± |
| M5-UT-11 | ç‰¹æ®Šè§„åˆ™ï¼šå·²å¤Ÿæ—¶æ€æ£‹ä¸”æœ€ç»ˆæœªç“· | è¯¥ç©å®¶ä¸èµ¢å¤Ÿæ£‹ç­¹ç ï¼ˆ`delta_enough=0`ï¼‰ï¼›å¯¹åº”æœªå¤Ÿç©å®¶ä¹Ÿæ— éœ€å‘å…¶æ”¯ä»˜å¤Ÿæ£‹ç­¹ç ï¼›æ€æ£‹ç›¸å…³ç­¹ç ä»ç‹¬ç«‹ç»“ç®— |
| M5-UT-12 | ç»“ç®—åçŠ¶æ€ä¿æŒ | `phase=settlement` æˆåŠŸ `settle` åï¼Œä¿æŒ `phase=settlement`ã€`version` ä¸å˜ï¼Œå¹¶è¿”å› `final_state + chip_delta_by_seat` |
| M5-UT-13 | é»‘æ£‹è·¯å¾„ç»“ç®— | é»‘æ£‹ç›´è¾¾ `settlement` å `settle` æˆåŠŸï¼›ä¸‰äºº `delta/delta_enough/delta_reveal/delta_ceramic` å…¨ä¸º 0 |

## 2) engine.cli ç»“ç®—å±•ç¤ºæµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M5-CLI-01 | CLI åœ¨ `phase=settlement` è‡ªåŠ¨è§¦å‘ç»“ç®— | `run_cli` æ£€æµ‹åˆ° settlement åè‡ªåŠ¨è°ƒç”¨ `engine.settle()`ï¼Œå¹¶æ‰“å°ç»“ç®—åŒºå—æ ‡é¢˜ |
| M5-CLI-02 | CLI å±•ç¤ºæŒ‰ seat æ‹†åˆ†çš„ç­¹ç å˜åŒ– | è¾“å‡ºåŒ…å«æ¯åç©å®¶ `delta/delta_enough/delta_reveal/delta_ceramic` |
| M5-CLI-03 | CLI å±•ç¤ºç»“ç®—å®ˆæ’ä¿¡æ¯ | è¾“å‡ºåŒ…å« `sum(delta)=0` å®ˆæ’æç¤ºï¼Œä¾¿äºæœ¬åœ°æ’æŸ¥ |
| M5-CLI-04 | settle ä¸å¯ç”¨æ—¶ä¿ç•™å…œåº•æ–‡æ¡ˆ | `engine.settle()` æŠ› `NotImplementedError` æ—¶ï¼Œè¾“å‡ºâ€œå½“å‰ç‰ˆæœ¬æœªå®ç° settleâ€å¹¶é€€å‡º |

## 3) åç«¯ç»“ç®—æ¥å£æµ‹è¯•ï¼ˆ/settlement + ç»“ç®—åé‡æ–° readyï¼‰

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M5-BE-01 | `GET /api/games/{id}/settlement` æˆåŠŸ | `phase=settlement` æ—¶è¿”å› 200ï¼ŒåŒ…å« `chip_delta_by_seat` ä¸ `final_state` |
| M5-BE-02 | `/settlement` phase é—¨ç¦ | `phase!=settlement` æ—¶è¿”å› `409 + GAME_STATE_CONFLICT` |
| M5-BE-03 | `/settlement` æˆå‘˜æƒé™ | éæˆ¿é—´æˆå‘˜è®¿é—®è¿”å› `403` |
| M5-BE-04 | `/settlement` èµ„æºä¸å­˜åœ¨ | `game_id` ä¸å­˜åœ¨è¿”å› `404 + GAME_NOT_FOUND` |
| M5-BE-05 | ç»“ç®—å ready è‡ªåŠ¨æ¸…é›¶ | è¿›å…¥ç»“ç®—å `room_detail.members[*].ready` å‡ä¸º `false` |
| M5-BE-06 | ç»“ç®—åä¸‰äººé‡æ–° ready è§¦å‘æ–°å±€ | ç¬¬ä¸‰äººåœ¨ç»“ç®—åæäº¤ ready=true æ—¶åˆ›å»ºæ–° `game_id`ï¼Œæˆ¿é—´åˆ‡å› `playing` |
| M5-BE-07 | ç»“ç®—åæœªå…¨å‘˜ ready ä¸å¼€å±€ | ä»…éƒ¨åˆ†æˆå‘˜ ready æ—¶ä¸åˆ›å»ºæ–°å±€ï¼Œä¿æŒç»“ç®—æ€ï¼ˆæˆ–çº¦å®šç­‰å¾…æ€ï¼‰ |
| M5-BE-08 | ç»“ç®—åéæˆå‘˜ ready æ‹’ç» | éæˆ¿é—´æˆå‘˜è°ƒç”¨ `/api/rooms/{room_id}/ready` è¿”å› `403` |
| M5-BE-09 | ç»“ç®—åå¹¶å‘ ready ä¸€è‡´æ€§ | ä¸‰äººå¹¶å‘ ready ä»…è§¦å‘ä¸€æ¬¡æ–°å±€åˆ›å»º |
| M5-BE-10 | é‡æ–° ready å¼€å±€åçš„ WS æ¨é€ | æ–°å±€åˆ›å»ºåæˆ¿é—´æ”¶åˆ° `ROOM_UPDATE` + æ–°å±€é¦–å¸§ `GAME_PUBLIC_STATE/GAME_PRIVATE_STATE` |

## 4) é€šç”¨æ–­è¨€ï¼ˆé€‚ç”¨äºæ¯ä¸ªæˆåŠŸç»“ç®—æ ·ä¾‹ï¼‰

- æ¯åç©å®¶å¿…é¡»æ»¡è¶³ï¼š`delta = delta_enough + delta_reveal + delta_ceramic`ã€‚
- ä¸‰äººæ€»å’Œå®ˆæ’ï¼š`sum(delta)=0`ï¼Œä¸” `sum(delta_enough)=sum(delta_reveal)=sum(delta_ceramic)=0`ã€‚
- è¿”å›ç»“æ„å®Œæ•´ï¼š`chip_delta_by_seat` é•¿åº¦ä¸º 3ï¼Œseat è¦†ç›– `0/1/2`ï¼Œä¸”ä¸ `final_state` å¯¹åº”ä¸€è‡´ã€‚
- æ¯ä¸ªæ ·ä¾‹å‰ç½®çŠ¶æ€éƒ½éœ€æ»¡è¶³æŸ±æ•°çº¦æŸï¼š`pillar_count_sum <= 8`ã€‚

## 5) é˜¶æ®µé€šè¿‡åˆ¤å®šï¼ˆå½“å‰å­èŒƒå›´ï¼‰

- `settle` çš„ phase é—¨ç¦ã€ç»“ç®—æ‹†åˆ†å­—æ®µï¼ˆenough/reveal/ceramicï¼‰ä¸çŠ¶æ€æ¨è¿›è¡Œä¸ºå…¨éƒ¨å¯æµ‹ã€‚
- â€œæ€æ—¶å·²å¤Ÿä½†æœ€ç»ˆæœªç“·â€çš„ç‰¹æ®Šè§„åˆ™è¢«æ˜ç¡®é”å®šï¼Œä¸”ä¸å¸¸è§„ enough ç»“ç®—äº’ä¸å†²çªã€‚
- é»‘æ£‹è·¯å¾„å¯ç›´æ¥ç»“ç®—ä¸”å¢é‡å…¨é›¶ï¼Œé¿å…å¼‚å¸¸åˆ†æ”¯æ¼æµ‹ã€‚
- æ‰€æœ‰æˆåŠŸç»“ç®—æ ·ä¾‹å‡ç»Ÿä¸€æ£€æŸ¥â€œåˆ†è§£ä¸€è‡´æ€§ + å…¨å±€å®ˆæ’â€ã€‚
- CLI åœ¨å¯ç»“ç®—åœºæ™¯å¯ç›´æ¥çœ‹åˆ°ç»“ç®—æ˜ç»†ï¼ˆå«æ‹†åˆ†å­—æ®µä¸å®ˆæ’æç¤ºï¼‰ï¼Œä¸å¯ç»“ç®—åœºæ™¯ä¿ç•™å†å²å…œåº•è¡Œä¸ºã€‚
- åç«¯ `/settlement` ä¸â€œç»“ç®—åé‡æ–° readyâ€å¥‘çº¦å…·å¤‡å¯æ‰§è¡Œç”¨ä¾‹ï¼Œè¦†ç›– phase é—¨ç¦ã€æƒé™ä¸å¼€å±€åˆ†æ”¯ã€‚

## 6) TDD æ‰§è¡Œè®°å½•ï¼ˆè¿›è¡Œä¸­ï¼‰

> è¯´æ˜ï¼šæŒ‰â€œäººç±»æŒ‡å®šæµ‹è¯•ID -> ç¼–å†™æµ‹è¯• -> æ‰§è¡Œ Red/Greenâ€æ¨è¿›ï¼›å½“å‰å·²å®Œæˆ `M5-UT-01~13` ä¸ `M5-BE-01~10`ã€‚

| æµ‹è¯•ID | å½“å‰çŠ¶æ€ | TDDé˜¶æ®µ | å¤‡æ³¨ |
|---|---|---|---|
| M5-UT-01 ~ M5-UT-04 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-17ï¼šå®ç° `engine/settlements.py` ç»“ç®—é€»è¾‘å¹¶æ›´æ–° `engine/core.py` çš„ `settle` è¿”å›ç»“æ„åï¼Œæ‰§è¡Œ `pytest engine/tests/test_m5_red_ut_01_04_settlement.py -q`ï¼Œç»“æœ `4 passed`ã€‚ |
| M5-UT-05 ~ M5-UT-08 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-17ï¼šæ‰§è¡Œ `pytest engine/tests/test_m5_red_ut_05_08_settlement.py -q`ï¼Œç»“æœ `4 passed`ã€‚ |
| M5-UT-09 ~ M5-UT-12 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-17ï¼šé¦–æ¬¡æ‰§è¡Œ `pytest engine/tests/test_m5_red_ut_09_12_settlement.py -q`ï¼Œç»“æœ `4 passed`ï¼›2026-02-21ï¼šç§»é™¤ `finished` ç»ˆæ€åå¤æµ‹åŒå‘½ä»¤ï¼Œç»“æœä»ä¸º `4 passed`ã€‚ |
| M5-UT-13 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-17ï¼šæ‰§è¡Œ `pytest engine/tests/test_m5_red_ut_13_settlement.py -q`ï¼Œç»“æœ `1 passed`ã€‚ |
| M5-CLI-01 ~ M5-CLI-04 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-20ï¼šåœ¨ `engine/cli.py` æ¥å…¥ç»“ç®—å±•ç¤ºï¼ˆè‡ªåŠ¨è§¦å‘ `settle`ã€è¾“å‡º seat æ‹†åˆ†ä¸å®ˆæ’æç¤ºï¼‰åæ‰§è¡Œ `pytest engine/tests/test_m5_red_cli_01_04_settlement.py -q`ï¼Œç»“æœ `4 passed`ï¼›2026-02-21ï¼šç»ˆæ€æ”¶æ•›åå¤æµ‹åŒå‘½ä»¤ï¼Œç»“æœä»ä¸º `4 passed`ã€‚ |
| M5-BE-01 ~ M5-BE-05 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šå…ˆæ‰§è¡Œ Redï¼ˆ`2 failed, 3 passed`ï¼Œå¤±è´¥ç‚¹ä¸º `/settlement` ç›¸ä½å£å¾„ä¸ä¸€è‡´ä¸é—¨ç¦è¢« `status` ç»•è¿‡ï¼‰ï¼›éšåå®æ–½â€œç§»é™¤ finished ç»ˆæ€ã€ä»…ä¿ç•™ settlementâ€æ”¹é€ åå¤æµ‹ `pytest backend/tests/api/games/test_m5_api_01_05_settlement_red.py -q`ï¼Œç»“æœ `5 passed`ã€‚ |
| M5-BE-06 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šæ–°å¢ `backend/tests/api/games/test_m5_api_06_10_ready_reopen_red.py` åæ‰§è¡Œé¦–è½® `pytest backend/tests/api/games/test_m5_api_06_10_ready_reopen_red.py -q`ï¼ˆç»“æœ `4 passed, 1 failed`ï¼‰ï¼›å…¶ä¸­ `M5-BE-06` æ–­è¨€é€šè¿‡ï¼Œç»“ç®—åä¸‰äºº ready ä¼šè§¦å‘æ–°å±€åˆ›å»ºå¹¶å›åˆ° `playing`ï¼›è¡¥é½ `M5-BE-10` åå…¨æ–‡ä»¶å¤æµ‹ç»“æœ `5 passed`ã€‚ |
| M5-BE-07 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šåŒæ‰¹æ¬¡æ‰§è¡Œä¸­é€šè¿‡ï¼›ä»…éƒ¨åˆ†æˆå‘˜ ready æ—¶ä¿æŒ `settlement`ï¼Œæœªæå‰å¼€æ–°å±€ã€‚ |
| M5-BE-08 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šåŒæ‰¹æ¬¡æ‰§è¡Œä¸­é€šè¿‡ï¼›éæˆå‘˜åœ¨ç»“ç®—åè°ƒç”¨ `/api/rooms/{room_id}/ready` è¿”å› `403 + ROOM_NOT_MEMBER`ã€‚ |
| M5-BE-09 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šåŒæ‰¹æ¬¡æ‰§è¡Œä¸­é€šè¿‡ï¼›å¹¶å‘ ready ä»…åˆ›å»ºä¸€æ¬¡æ–°å±€ï¼ˆ`current_game_id` ä»æ—§å±€é€’å¢ä¸€æ¬¡ï¼‰ã€‚ |
| M5-BE-10 | ğŸŸ¢ Green å·²æ‰§è¡Œ | Green å·²å®Œæˆ | 2026-02-21ï¼šå…ˆ Redï¼ˆç¼ºå°‘â€œé‡æ–°å¼€å±€å WS æ–°å±€ `GAME_PUBLIC_STATE/GAME_PRIVATE_STATE` é¦–å¸§æ¨é€â€ï¼‰ï¼Œååœ¨ `set_room_ready` å¼€å±€åˆ†æ”¯è¡¥é½â€œ`ROOM_UPDATE` åä¸²è¡Œæ¨é€æ–°å±€ public/privateâ€å¹¿æ’­å¹¶å¤æµ‹ `pytest backend/tests/api/games/test_m5_api_06_10_ready_reopen_red.py -q`ï¼Œç»“æœ `5 passed`ã€‚ |
