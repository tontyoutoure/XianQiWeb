# M3 é˜¶æ®µæµ‹è¯•åˆ—è¡¨ï¼ˆå¯¹å±€å¼•æ“æ ¸å¿ƒè§„åˆ™ï¼‰

> ä¾æ®æ–‡æ¡£ï¼š`memory-bank/implementation-plan.md`ï¼ˆM3ï¼‰ã€`memory-bank/interfaces/backend-engine-interface.md`ã€`memory-bank/design/engine_design.md`ã€`XianQi_rules.md`ã€‚
> ç›®æ ‡ï¼šå…ˆå›ºåŒ– M3 TDD æµ‹è¯•æ¸…å•ï¼Œå†æŒ‰â€œäººç±»æŒ‡å®šæµ‹è¯•ID -> ç¼–å†™æµ‹è¯• -> çº¢ç»¿æ¨è¿›â€æ‰§è¡Œã€‚

## 0) æµ‹è¯•è¿è¡Œç¯å¢ƒä¸æ‰§è¡Œçº¦å®š

- å»ºè®®ç¯å¢ƒï¼šconda `XQB`ã€‚
- å»ºè®®å‘½ä»¤ï¼š`conda run -n XQB pytest engine/tests -q`ã€‚
- çº¦å®šï¼šM3 ä¼˜å…ˆåšå¼•æ“çº¯å•æµ‹ï¼ˆä¸ä¾èµ–åç«¯ APIï¼‰ã€‚
- æœ¬æ–‡æ¡£ç”¨äºè®°å½•æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ Red/Green ç»“æœã€‚

## 1) å¼•æ“åŸºç¡€èƒ½åŠ›æµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M3-UT-01 | `init_game` å‘ç‰Œæ€»é‡ä¸æ¯äººæ‰‹ç‰Œå¼ æ•° | ä¸‰äººæ€»ç‰Œæ•°æ’ä¸º 24ï¼›æ¯äººèµ·æ‰‹ 8 å¼  |
| M3-UT-02 | `init_game` å›ºå®š seed å¯å¤ç° | ç›¸åŒ `rng_seed` ä¸‹å‘ç‰Œç»“æœã€å…ˆæ‰‹ seat ä¸€è‡´ |
| M3-UT-03 | é»‘æ£‹åˆ¤å®š | ä»»ä¸€ç©å®¶èµ·æ‰‹æ— å£«/ç›¸æ—¶ï¼Œ`phase` ç›´æ¥è¿›å…¥ `settlement` |
| M3-UT-04 | çŠ¶æ€ç‰ˆæœ¬å·é€’å¢è§„åˆ™ | åŠ¨ä½œæˆåŠŸå `version +1`ï¼›éæ³•åŠ¨ä½œä¸æ”¹å˜ `version` |
| M3-UT-05 | `dump_state/load_state` ä¸€è‡´æ€§ | dump å loadï¼Œ`public/private/legal_actions` ä¸ dump å‰ä¸€è‡´ |

## 2) ç»„åˆæšä¸¾å™¨æµ‹è¯•ï¼ˆé‡ç‚¹ç»†åŒ–ï¼‰

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M3-CB-01 | å•å¼ æšä¸¾ï¼ˆå»é‡ï¼‰ | åŒä¸€ `card_type` åªäº§å‡º 1 ä¸ªå•å¼ ç»„åˆï¼Œä¸å—è¯¥ç±»å‹ `count` å½±å“ |
| M3-CB-02 | åŒå‹å¯¹å­æšä¸¾ | å½“æŸ `card_type.count >= 2` æ—¶äº§å‡ºè¯¥ç±»å‹å¯¹å­ï¼›`count < 2` ä¸äº§å‡º |
| M3-CB-03 | ç‹—è„šå¯¹æšä¸¾ï¼ˆR_GOU+B_GOUï¼‰ | ä»…å½“ `R_GOU>=1 ä¸” B_GOU>=1` æ—¶äº§å‡º `dog_pair` |
| M3-CB-04 | ç‹—è„šå¯¹äº’æ–¥å»é‡ | ç‹—è„šå¯¹åªäº§å‡º 1 æ¡ï¼Œä¸å› æšä¸¾é¡ºåºäº§ç”Ÿé‡å¤é¡¹ |
| M3-CB-05 | ä¸‰ç‰›æšä¸¾ï¼ˆçº¢/é»‘ï¼‰ | ä»…å½“ `R_NIU>=3` äº§å‡ºçº¢ä¸‰ç‰›ï¼›ä»…å½“ `B_NIU>=3` äº§å‡ºé»‘ä¸‰ç‰› |
| M3-CB-06 | éæ³•ä¸‰å¼ ä¸åº”äº§å‡º | éç‰›ä¸‰å¼ ã€æ··è‰²ä¸‰å¼ éƒ½ä¸ä¼šè¿›å…¥ç»„åˆæšä¸¾ç»“æœ |
| M3-CB-07 | å¯¹å­ç‰ŒåŠ›é¡ºåº | `dog_pair = çº¢å£«å¯¹ > é»‘å£«å¯¹ > å…¶ä»–å¯¹å­`ï¼Œæ’åºç¨³å®š |
| M3-CB-08 | ä¸‰å¼ ç‰ŒåŠ›é¡ºåº | çº¢ä¸‰ç‰› > é»‘ä¸‰ç‰› |
| M3-CB-09 | å•å¼ ç‰ŒåŠ›é¡ºåº | æ»¡è¶³æ¥å£æ–‡æ¡£ç‰ŒåŠ›è¡¨ï¼ˆ`R_SHI` æœ€é«˜ï¼Œ`B_NIU` æœ€ä½ï¼‰ |
| M3-CB-10 | ç»„åˆæ’åºç¨³å®šæ€§ | åŒä¸€æ‰‹ç‰Œå¤šæ¬¡è°ƒç”¨æšä¸¾ï¼Œè¾“å‡ºé¡ºåºå®Œå…¨ä¸€è‡´ |
| M3-CB-11 | æŒ‰ `round_kind` è¿‡æ»¤ | æŒ‡å®š `round_kind=1/2/3` æ—¶ä»…è¿”å›å¯¹åº”å¼ æ•°ç»„åˆ |
| M3-CB-12 | ä¸¥æ ¼å¤§äºæ¯”è¾ƒ | å‹åˆ¶åˆ¤å®šåªæ¥å— `power > last_combo.power`ï¼Œ`=` ä¸å¯å‹åˆ¶ |
| M3-CB-13 | çº¢ç‹—ä¸çº¢è½¦å•å¼ ç­‰ä»·ç‰ŒåŠ› | `R_GOU` å•å¼  `power` å¿…ç­‰äº `R_CHE` |
| M3-CB-14 | é»‘ç‹—ä¸é»‘è½¦å•å¼ ç­‰ä»·ç‰ŒåŠ› | `B_GOU` å•å¼  `power` å¿…ç­‰äº `B_CHE` |

## 3) åˆæ³•åŠ¨ä½œæšä¸¾æµ‹è¯•ï¼ˆé‡ç‚¹ç»†åŒ–ï¼‰

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M3-LA-01 | `buckle_decision` åŠ¨ä½œé›†åˆ | ä»…åŒ…å« `PLAY` ä¸æœ€å¤š 1 ä¸ª `BUCKLE` |
| M3-LA-02 | `buckle_decision` çš„ PLAY å®Œæ•´æ€§ | æ‰€æœ‰å¯å‡ºçš„å•å¼ /å¯¹å­/ä¸‰ç‰›å‡è¢«è¦†ç›–ï¼Œæ— é—æ¼ |
| M3-LA-03 | `buckle_decision` æ’åºç¨³å®š | å¤šæ¬¡è°ƒç”¨ `get_legal_actions`ï¼Œ`actions` é¡ºåºä¸€è‡´ |
| M3-LA-04 | `in_round` å¯å‹åˆ¶æ—¶äº’æ–¥è§„åˆ™ | è‹¥å­˜åœ¨å¯å‹åˆ¶ç»„åˆï¼Œä»…è¿”å› `PLAY`ï¼Œä¸è¿”å› `COVER` |
| M3-LA-05 | `in_round` ä¸å¯å‹åˆ¶æ—¶äº’æ–¥è§„åˆ™ | è‹¥æ— å¯å‹åˆ¶ç»„åˆï¼Œä»…è¿”å› 1 ä¸ª `COVER(required_count=round_kind)` |
| M3-LA-06 | `COVER.required_count` æ­£ç¡® | `required_count` å¿…ç­‰äºå½“å‰ `round_kind` |
| M3-LA-07 | `in_round` å‹åˆ¶é›†åˆæ­£ç¡®æ€§ | è¿”å›çš„ PLAY å…¨éƒ¨å¯å‹åˆ¶ä¸”ä¸åŒ…å«ä¸å¯å‹åˆ¶ç»„åˆ |
| M3-LA-08 | éå½“å‰å†³ç­– seat çš„åŠ¨ä½œ | `seat != decision.seat` æ—¶è¿”å›ç©º `actions` |
| M3-LA-09 | `reveal_decision` åŠ¨ä½œé›†åˆ | ä»…åŒ…å« `REVEAL` ä¸ `PASS_REVEAL` |
| M3-LA-10 | `settlement/finished` æ— åŠ¨ä½œ | `get_legal_actions` è¿”å›ç©º `actions` |
| M3-LA-11 | `action_idx` ç¨³å®šæ€§ | åŒä¸€çŠ¶æ€å¤šæ¬¡è·å– `actions`ï¼Œç´¢å¼•å«ä¹‰ä¸æ¼‚ç§» |
| M3-LA-12 | phase åˆ‡æ¢ååŠ¨ä½œåˆ·æ–° | `apply_action` åä¸‹ä¸€çŠ¶æ€çš„ `actions` ä¸æ–° `decision.seat` ä¸€è‡´ |
| M3-LA-13 | `buckle_decision` ä¸‹ PLAY ç»„åˆå…¨é›†è¦†ç›– | PLAY å¿…é¡»è¦†ç›–å•å¼ /å¯¹å­/ç‹—è„šå¯¹/ä¸‰ç‰›å…¨éƒ¨å¯å‡ºç»„åˆ |
| M3-LA-14 | `buckle_decision` PLAY ä¸ç»„åˆæšä¸¾ä¸€è‡´æ€§ | PLAY çš„ `payload_cards` ä¸ `enumerate_combos` ç»“æœä¸€ä¸€å¯¹åº” |
| M3-LA-15 | `in_round` å•å¼ å¯å‹åˆ¶å…¨é›† | ä»…è¿”å›æ‰€æœ‰ `power > last_combo.power` çš„å•å¼  PLAY |
| M3-LA-16 | `in_round` å¯¹å­å¯å‹åˆ¶å…¨é›†ï¼ˆå«ç‹—è„šå¯¹ï¼‰ | è¿”å›æ‰€æœ‰å¯å‹åˆ¶å¯¹å­ PLAYï¼Œä¸”åŒ…å«ç‹—è„šå¯¹å‹åˆ¶åœºæ™¯ |
| M3-LA-17 | `in_round` å¯¹å­ä¸¥æ ¼å¤§äºè¾¹ç•Œ | `power == last_combo.power` çš„å¯¹å­ä¸å¾—å‡ºç°åœ¨ PLAY åˆ—è¡¨ |
| M3-LA-18 | `in_round` ä¸‰ç‰›å¯å‹åˆ¶å…¨é›† | ä»…è¿”å›å¯å‹åˆ¶ä¸‰ç‰› PLAYï¼Œé»‘ä¸‰ç‰›ä¸å¯å‹åˆ¶çº¢ä¸‰ç‰› |
| M3-LA-19 | `in_round` PLAY å¼ æ•°ä¸ `round_kind` ä¸€è‡´ | æ‰€æœ‰ PLAY çš„ç‰Œå¼ æ€»æ•°éƒ½å¿…é¡»ç­‰äº `round_kind` |
| M3-LA-20 | `in_round` å•å¼ å»é‡ | åŒä¸€ `card_type` å³ä½¿ `count>1`ï¼ŒPLAY å•å¼ ä¹Ÿåªå‡ºç°ä¸€æ¬¡ |
| M3-LA-21 | `buckle_decision` PLAY é¡ºåºç¨³å®šæ€§ï¼ˆæ‰©å±•ï¼‰ | è¿ç»­å¤šæ¬¡è·å–åŠ¨ä½œï¼ŒPLAY ç»„åˆé¡ºåºå®Œå…¨ä¸€è‡´ |
| M3-LA-22 | `in_round` PLAY é¡ºåºç¨³å®šæ€§ï¼ˆæ‰©å±•ï¼‰ | è¿ç»­å¤šæ¬¡è·å–åŠ¨ä½œï¼ŒPLAY ç»„åˆé¡ºåºå®Œå…¨ä¸€è‡´ |

## 4) åŠ¨ä½œæ‰§è¡Œä¸æ ¡éªŒè¡¥å……æµ‹è¯•

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M3-ACT-01 | `action_idx` è¶Šç•Œ | å¼•æ“è¿”å› `ENGINE_INVALID_ACTION_INDEX` |
| M3-ACT-02 | `client_version` å†²çª | å¼•æ“è¿”å› `ENGINE_VERSION_CONFLICT` |
| M3-ACT-03 | é COVER ä¼  `cover_list` | å¼•æ“æ‹’ç»å¹¶è¿”å› `ENGINE_INVALID_COVER_LIST` |
| M3-ACT-04 | COVER ä¼ é”™å¼ æ•° | `cover_list` æ€»å¼ æ•°ä¸ç­‰äº `required_count` æ—¶æ‹’ç» |
| M3-ACT-05 | COVER ä¼ ä¸å­˜åœ¨æ‰‹ç‰Œ | `cover_list` è¶…å‡ºæŒç‰Œæ—¶æ‹’ç» |
| M3-ACT-06 | å›åˆç»“æŸåå†³ç­–ä½æ¨è¿› | 3 äººå‡ºå®Œå `decision.seat` åˆ‡åˆ° round winner |
| M3-ACT-07 | æ€æ£‹é¡ºåºæ¨è¿› | `reveal.pending_order` æ¶ˆè´¹ä¸ `decision.seat` æ¨è¿›ä¸€è‡´ |
| M3-ACT-08 | ä¸€è½®ç»“æŸåæ£‹æŸ±å½’å± | `pillar_groups` æ–°å¢è®°å½•ä¸” `winner_seat` ç­‰äºæœ¬è½®æœ€å¤§ç»„åˆç©å®¶ |
| M3-ACT-09 | å¯¹å­å›åˆåˆ†æŸ±æ‹†åˆ† | `round_kind=2` æ—¶æ–°å¢ 2 æŸ±ï¼Œä¸”åŒä¸€å¯¹ï¼ˆå¦‚ `R_SHI` å¯¹ï¼‰æ‹†åˆ°ä¸åŒæŸ± |
| M3-ACT-10 | ä¸‰ç‰›å›åˆåˆ†æŸ±æ‹†åˆ† | `round_kind=3` æ—¶æ–°å¢ 3 æŸ±ï¼Œä¸”ä¸‰å¼ åŒå‹ç‰›åˆ†æ•£åˆ° 3 æ ¹æŸ± |

### 4.1 å‘½ä»¤è¡Œäº¤äº’æµ‹è¯•ï¼ˆæ–°å¢éœ€æ±‚ï¼‰

| æµ‹è¯•ID | æµ‹è¯•æè¿° | é€šè¿‡æ¡ä»¶ |
|---|---|---|
| M3-CLI-01 | æ˜¾å¼ seed å¯åŠ¨å¯å¤ç° | ç›¸åŒ `--seed` å¯åŠ¨ä¸¤æ¬¡ï¼Œé¦–å¸§å…¬å…±æ€ï¼ˆå«å…ˆæ‰‹/æ‰‹ç‰Œåˆ†å¸ƒï¼‰ä¸€è‡´ |
| M3-CLI-02 | æœªä¼  seed æ—¶è‡ªåŠ¨å–æ—¶é—´ | ä¸ä¼  `--seed` å¯åŠ¨ï¼ŒCLI è¾“å‡ºå®é™… seed ä¸”å¯ç”¨äºå¤ç° |
| M3-CLI-03 | è½®è½¬æ‰®æ¼”ä¸‰åº§æ¬¡ | æ¯ä¸€æ­¥æç¤ºå½“å‰ `decision.seat`ï¼Œå¹¶æŒ‰ seat0/1/2 è½®è½¬æ¨è¿› |
| M3-CLI-04 | çŠ¶æ€å±•ç¤ºå£å¾„ | æ¯æ­¥å±•ç¤ºå…¬å…±æ€æ‘˜è¦ + å½“å‰ seat ç§æœ‰æ€ï¼›ä¸é»˜è®¤æ³„éœ²å…¶ä»– seat ç§æœ‰æ€ |
| M3-CLI-05 | åˆæ³•åŠ¨ä½œåˆ—è¡¨ä¸ç´¢å¼• | CLI æŒ‰ `get_legal_actions` é¡ºåºå±•ç¤ºå…¨éƒ¨åŠ¨ä½œï¼Œ`action_idx` å¯ç›´æ¥æäº¤ |
| M3-CLI-06 | COVER è¾“å…¥é“¾è·¯ | é€‰æ‹© COVER åå¯è¾“å…¥ `cover_list`ï¼Œå¼ æ•°/æŒç‰Œéæ³•æ—¶æç¤ºå¹¶é‡è¯• |
| M3-CLI-07 | åŠ¨ä½œæ‰§è¡Œå¤±è´¥é‡è¯• | éæ³•è¾“å…¥æˆ–å¼•æ“é”™è¯¯ï¼ˆå¦‚ `ENGINE_INVALID_ACTION_INDEX`ï¼‰ä¸æ”¹çŠ¶æ€å¹¶å¯é‡é€‰ |
| M3-CLI-08 | å¯¹å±€ç»“æŸè¡Œä¸º | åˆ° `settlement/finished` æ—¶èƒ½ç»™å‡ºæ˜ç¡®æç¤ºå¹¶ç»“æŸï¼ˆæˆ–è§¦å‘ `settle` æµç¨‹ï¼‰ |

## 5) é˜¶æ®µé€šè¿‡åˆ¤å®šï¼ˆM3ï¼‰

- ç»„åˆæšä¸¾ä¸ç‰ŒåŠ›æ¯”è¾ƒè§„åˆ™å®Œæ•´å¯æµ‹ï¼Œä¸”é¡ºåºç¨³å®šã€‚
- åˆæ³•åŠ¨ä½œç”Ÿæˆæ»¡è¶³ phase çº¦æŸä¸äº’æ–¥è§„åˆ™ï¼ˆPLAY/COVERã€REVEAL/PASS_REVEALï¼‰ã€‚
- `action_idx + cover_list + client_version` ä¸‰æ¡æ ¸å¿ƒæ ¡éªŒé“¾è·¯å‡æœ‰çº¢ç»¿è¦†ç›–ã€‚
- å†³ç­–ä½ï¼ˆ`decision.seat`ï¼‰åœ¨æ¯æ¬¡çŠ¶æ€æ¨è¿›åä¸ `turn.current_seat` ä¸€è‡´ã€‚
- å›åˆç»“ç®—å…¥æŸ±åï¼Œæ£‹æŸ±å½’å±ä¸åˆ†æŸ±è§„åˆ™ï¼ˆå¯¹å­/ä¸‰ç‰›æ‹†æŸ±ï¼‰å¯éªŒè¯ä¸”ç¨³å®šã€‚
- CLI å¯åœ¨å‘½ä»¤è¡Œä¸­æŒ‰å†³ç­–åº§æ¬¡æ¨è¿›ä¸€å±€ï¼Œå¹¶ç¨³å®šå±•ç¤ºå…¬å…±æ€/ç§æœ‰æ€ä¸åˆæ³•åŠ¨ä½œã€‚

## 6) Mock æ•°æ®ä¸é¢„æœŸï¼ˆå®¡æŸ¥ç‰ˆï¼‰

### 6.1 ç»„åˆæšä¸¾å™¨ï¼ˆM3-CBï¼‰å®¡æŸ¥æ ·ä¾‹

| æµ‹è¯•ID | Mock è¾“å…¥ï¼ˆæ˜¾å¼ï¼‰ | é¢„æœŸç»“æœï¼ˆæ˜¾å¼ï¼‰ |
|---|---|---|
| M3-CB-01 | `hand={"R_SHI":2,"B_NIU":1}`ï¼Œ`round_kind=null` | è‡³å°‘åŒ…å« `R_SHI` å•å¼ ã€`B_NIU` å•å¼ ã€`R_SHI` å¯¹å­ï¼›åŒç‰Œå‹ä¸é‡å¤ |
| M3-CB-02 | `hand={"R_SHI":1,"R_MA":2,"B_NIU":1}`ï¼Œ`round_kind=2` | åŒ…å« `R_MA` å¯¹å­ï¼›ä¸åŒ…å« `R_SHI` å¯¹å­ã€ä¸åŒ…å« `B_NIU` å¯¹å­ |
| M3-CB-03 | å­åœºæ™¯Aï¼š`{"R_GOU":1,"B_GOU":1}`ï¼›å­åœºæ™¯Bï¼š`{"R_GOU":1,"B_GOU":0}`ï¼Œå‡ `round_kind=2` | A åŒ…å«ç‹—è„šå¯¹ï¼›B ä¸åŒ…å«ç‹—è„šå¯¹ |
| M3-CB-04 | `hand={"R_GOU":1,"B_GOU":1}`ï¼Œ`round_kind=2` | ç‹—è„šå¯¹ä»…å‡ºç° 1 æ¬¡ï¼ˆæ— é‡å¤ï¼‰ |
| M3-CB-05 | å­åœºæ™¯Aï¼š`{"R_NIU":3,"B_NIU":2}`ï¼›å­åœºæ™¯Bï¼š`{"R_NIU":2,"B_NIU":3}`ï¼Œ`round_kind=3` | A ä»…çº¢ä¸‰ç‰›ï¼›B ä»…é»‘ä¸‰ç‰› |
| M3-CB-06 | `hand={"R_SHI":2,"R_NIU":2,"B_NIU":1}`ï¼Œ`round_kind=3` | ä¸è¿”å›ä»»ä½•ä¸‰å¼ ç»„åˆ |
| M3-CB-07 | `hand={"R_GOU":1,"B_GOU":1,"R_SHI":2,"B_SHI":2,"R_MA":2}`ï¼Œ`round_kind=2` | ç‰ŒåŠ›æ»¡è¶³ï¼šç‹—è„šå¯¹ = çº¢å£«å¯¹ > é»‘å£«å¯¹ > å…¶ä»–å¯¹å­ï¼ˆå¦‚çº¢é©¬å¯¹ï¼‰ï¼›æ’åºç¨³å®š |
| M3-CB-08 | `hand={"R_NIU":3,"B_NIU":3}`ï¼Œ`round_kind=3` | æ’åºæ»¡è¶³ï¼šçº¢ä¸‰ç‰›åœ¨é»‘ä¸‰ç‰›å‰ |
| M3-CB-09 | `hand={"R_SHI":1,"B_SHI":1,"R_XIANG":1,"B_XIANG":1,"R_MA":1,"B_MA":1,"R_CHE":1,"B_CHE":1,"R_GOU":1,"B_GOU":1,"R_NIU":1,"B_NIU":1}`ï¼Œ`round_kind=1` | å•å¼ ç‰ŒåŠ›é¡ºåºä¸¥æ ¼ç¬¦åˆæ¥å£æ–‡æ¡£ï¼ˆ`R_SHI` æœ€é«˜ï¼Œ`B_NIU` æœ€ä½ï¼‰ |
| M3-CB-10 | ä»»ä¸€å›ºå®šæ‰‹ç‰Œï¼ˆå»ºè®®ç”¨ CB-07ï¼‰é‡å¤è°ƒç”¨ 3 æ¬¡ | ç»„åˆåˆ—è¡¨é¡ºåºä¸å†…å®¹å®Œå…¨ä¸€è‡´ |
| M3-CB-11 | `hand={"R_SHI":2,"R_GOU":1,"B_GOU":1,"R_NIU":3}`ï¼Œåˆ†åˆ«æµ‹è¯• `round_kind=1/2/3` | kind=1 ä»…å•å¼ ï¼›kind=2 ä»…å¯¹å­ï¼ˆå«ç‹—è„šå¯¹ï¼‰ï¼›kind=3 ä»…ä¸‰ç‰› |
| M3-CB-12 | `hand={"R_SHI":1,"B_SHI":1,"R_NIU":1,"B_NIU":1}`ï¼Œ`round_kind=1`ï¼Œ`last_combo.power=8`ï¼ˆå¯å‹åˆ¶è¿‡æ»¤ï¼‰ | ä»… `power>8` çš„ç»„åˆå¯å‹åˆ¶ï¼ˆå³ä»…çº¢å£«ï¼‰ï¼›é»‘å£«ï¼ˆ=8ï¼‰ä¸å¯å‹åˆ¶ |
| M3-CB-13 | `hand={"R_GOU":1,"R_CHE":1}`ï¼Œ`round_kind=1` | `R_GOU` ä¸ `R_CHE` å•å¼  `power` ç›¸ç­‰ |
| M3-CB-14 | `hand={"B_GOU":1,"B_CHE":1}`ï¼Œ`round_kind=1` | `B_GOU` ä¸ `B_CHE` å•å¼  `power` ç›¸ç­‰ |

### 6.2 åˆæ³•åŠ¨ä½œæšä¸¾ï¼ˆM3-LAï¼‰å®¡æŸ¥æ ·ä¾‹

| æµ‹è¯•ID | Mock è¾“å…¥ï¼ˆæ˜¾å¼ï¼‰ | é¢„æœŸç»“æœï¼ˆæ˜¾å¼ï¼‰ |
|---|---|---|
| M3-LA-01 | `phase=buckle_decision`ï¼Œ`decision.seat=0`ï¼Œ`seat0.hand={"R_SHI":2,"R_GOU":1,"B_GOU":1}` | actions ä»…å« PLAY ä¸æœ€å¤š 1 ä¸ª BUCKLE |
| M3-LA-02 | åŒ LA-01 | PLAY è¦†ç›–å•å¼ /å¯¹å­ï¼ˆå«ç‹—è„šå¯¹ï¼‰å…¨éƒ¨å¯å‡ºç»„åˆï¼Œæ— é—æ¼ |
| M3-LA-03 | åŒ LA-01ï¼Œè¿ç»­è°ƒç”¨ 3 æ¬¡ | actions é¡ºåºå®Œå…¨ä¸€è‡´ |
| M3-LA-04 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=1`ï¼Œ`last_combo.power=2`ï¼Œ`seat1.hand={"R_SHI":1}` | ä»…è¿”å› PLAYï¼ˆä¸è¿”å› COVERï¼‰ |
| M3-LA-05 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=1`ï¼Œ`last_combo.power=9`ï¼Œ`seat1.hand={"B_NIU":1}` | ä»…è¿”å› 1 ä¸ª COVER |
| M3-LA-06 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=2`ï¼Œ`last_combo.power=3`ï¼Œ`seat1.hand={"R_SHI":1,"R_XIANG":1}` | è¿”å› COVERï¼Œä¸” `required_count=2`ï¼ˆè™½ç„¶å•å¼ ç‰ŒåŠ›é«˜ï¼Œä½†å› å‡‘ä¸å‡ºä»»ä½•åˆæ³•å¯¹å­åªèƒ½å«ç‰Œï¼‰ |
| M3-LA-07 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=2`ï¼Œ`last_combo.power=6`ï¼Œ`seat1.hand={"R_SHI":2,"R_MA":2,"B_NIU":2}` | è¿”å›çš„ PLAY å…¨éƒ¨ `power>6`ï¼Œä¸”ä¸åŒ…å«ä¸å¯å‹åˆ¶ç»„åˆ |
| M3-LA-08 | ä»»ä¸€å¯è¡ŒåŠ¨çŠ¶æ€ï¼Œä½†è°ƒç”¨ `get_legal_actions(seat!=decision.seat)` | è¿”å› `{"seat":x,"actions":[]}` |
| M3-LA-09 | `phase=reveal_decision`ï¼Œ`decision.seat=2` | actions ä»…å« `REVEAL` ä¸ `PASS_REVEAL` |
| M3-LA-10 | `phase=settlement` æˆ– `phase=finished` | actions ä¸ºç©º |
| M3-LA-11 | å›ºå®šåŒä¸€çŠ¶æ€ï¼ˆå»ºè®® LA-04ï¼‰è¿ç»­å– `actions` | æ¯ä¸ª `action_idx` è¯­ä¹‰ä¸æ¼‚ç§» |
| M3-LA-12 | å¯¹åŒä¸€å±€é¢å…ˆæ‰§è¡Œä¸€æ¬¡ `apply_action` å†å– `actions` | æ–°çŠ¶æ€ actions ä¸æ–°çš„ `decision.seat` ä¸€è‡´ |
| M3-LA-13 | `phase=buckle_decision`ï¼Œ`decision.seat=0`ï¼Œ`seat0.hand={"R_SHI":2,"R_GOU":1,"B_GOU":1,"R_NIU":3}` | PLAY åŒæ—¶è¦†ç›–å•å¼ ã€åŒå‹å¯¹å­ã€ç‹—è„šå¯¹ã€çº¢ä¸‰ç‰› |
| M3-LA-14 | åŒ LA-13 | PLAY çš„ `payload_cards` é›†åˆä¸ `enumerate_combos(hand)` è¾“å‡ºä¸€è‡´ |
| M3-LA-15 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=1`ï¼Œ`last_combo.power=3`ï¼Œ`seat1.hand={"R_SHI":1,"B_SHI":1,"R_XIANG":1,"B_CHE":1}` | PLAY ä»…å«çº¢å£«/é»‘å£«/çº¢ç›¸ï¼ˆå…¨éƒ¨ `power>3`ï¼‰ |
| M3-LA-16 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=2`ï¼Œ`last_combo.power=4`ï¼Œ`seat1.hand={"R_SHI":2,"B_SHI":2,"R_MA":2,"R_GOU":1,"B_GOU":1,"B_NIU":2}` | PLAY å«ç‹—è„šå¯¹ã€çº¢å£«å¯¹ã€é»‘å£«å¯¹ã€çº¢é©¬å¯¹ï¼›ä¸å«é»‘ç‰›å¯¹ |
| M3-LA-17 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=2`ï¼Œ`last_combo.power=8`ï¼Œ`seat1.hand={"R_SHI":2,"B_SHI":2,"R_MA":2,"R_GOU":1,"B_GOU":1}` | PLAY ä»…å«ç‹—è„šå¯¹ä¸çº¢å£«å¯¹ï¼Œä¸å«é»‘å£«å¯¹ï¼ˆç­‰äºè¾¹ç•Œï¼‰ |
| M3-LA-18 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=3`ï¼Œ`last_combo.power=10`ï¼Œ`seat1.hand={"R_NIU":3,"B_NIU":3}` | PLAY ä»…å«çº¢ä¸‰ç‰› |
| M3-LA-19 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=2`ï¼Œ`last_combo.power=0`ï¼Œ`seat1.hand={"R_SHI":2,"B_SHI":1,"R_NIU":3,"R_MA":2}` | æ‰€æœ‰ PLAY å‡ä¸º 2 å¼ ç»„åˆï¼Œä¸æ··å…¥å•å¼ /ä¸‰å¼  |
| M3-LA-20 | `phase=in_round`ï¼Œ`decision.seat=1`ï¼Œ`round_kind=1`ï¼Œ`last_combo.power=0`ï¼Œ`seat1.hand={"R_SHI":2,"B_SHI":1}` | `R_SHI` å•å¼  PLAY ä»…å‡ºç° 1 æ¬¡ |
| M3-LA-21 | å›ºå®š LA-13 çŠ¶æ€ï¼Œè¿ç»­è°ƒç”¨ 3 æ¬¡ `get_legal_actions` | PLAY åºåˆ—ï¼ˆç­¾åï¼‰å®Œå…¨ä¸€è‡´ |
| M3-LA-22 | å›ºå®š LA-16 çŠ¶æ€ï¼Œè¿ç»­è°ƒç”¨ 3 æ¬¡ `get_legal_actions` | PLAY åºåˆ—ï¼ˆç­¾åï¼‰å®Œå…¨ä¸€è‡´ |

### 6.3 åŠ¨ä½œæ‰§è¡Œä¸æ£‹æŸ±ç”Ÿæˆï¼ˆæ–°å¢éœ€æ±‚ï¼‰

| æµ‹è¯•ID | Mock è¾“å…¥ï¼ˆæ˜¾å¼ï¼‰ | é¢„æœŸç»“æœï¼ˆæ˜¾å¼ï¼‰ |
|---|---|---|
| M3-ACT-08 | æ„é€ ä¸€è½®ç»“æŸåœºæ™¯ï¼š3 äººå®ŒæˆåŒä¸€è½®å‡ºç‰Œåè§¦å‘æ”¶è½®ï¼Œä¸” `last_combo.owner_seat=1` | `pillar_groups` è¿½åŠ  1 ç»„ï¼Œæ–°å¢ç»„ `winner_seat=1`ï¼Œä¸”è¯¥ç»„å½’æ¡£çš„å›åˆæ•°æ®ä¸ `turn.plays` ä¸€è‡´ |
| M3-ACT-09 | å¯¹å­è½®ï¼ˆ`round_kind=2`ï¼‰ä¸” winner ä¸º seat1ï¼Œç¤ºä¾‹å« `R_SHI` å¯¹å‚ä¸æ”¶è½® | æ–°å¢ç»„å†…æ€»è®¡ç”Ÿæˆ 2 æŸ±ï¼›ä¸¤å¼  `R_SHI` åˆ†åˆ«ä½äºä¸åŒæŸ±ï¼ˆä¸å¯åŒæŸ±å †å ï¼‰ |
| M3-ACT-10 | ä¸‰ç‰›è½®ï¼ˆ`round_kind=3`ï¼‰ä¸” winner ä¸º seat2ï¼Œç¤ºä¾‹å« `R_NIU*3` æˆ– `B_NIU*3` | æ–°å¢ç»„å†…æ€»è®¡ç”Ÿæˆ 3 æŸ±ï¼›ä¸‰å¼ åŒå‹ç‰›åˆ†åˆ«ä½äº 3 æ ¹æŸ±ï¼ˆæ¯æŸ±è‡³å¤š 1 å¼ è¯¥åŒå‹ç‰›ï¼‰ |

### 6.4 å‘½ä»¤è¡Œäº¤äº’ï¼ˆæ–°å¢éœ€æ±‚ï¼‰

| æµ‹è¯•ID | Mock è¾“å…¥ï¼ˆæ˜¾å¼ï¼‰ | é¢„æœŸç»“æœï¼ˆæ˜¾å¼ï¼‰ |
|---|---|---|
| M3-CLI-01 | `python -m engine.cli --seed 20260217` è¿ç»­å¯åŠ¨ä¸¤æ¬¡ | ä¸¤æ¬¡éƒ½æ‰“å°ç›¸åŒ seedï¼Œä¸”é¦–è½® `decision.seat` ä¸ 3 åç©å®¶èµ·æ‰‹åˆ†å¸ƒä¸€è‡´ |
| M3-CLI-02 | `python -m engine.cli`ï¼ˆæ—  seedï¼‰ | è¾“å‡ºâ€œå®é™… seed=xxxxxxâ€ï¼›å¤åˆ¶è¯¥ seed å†æ¬¡å¯åŠ¨å¯å¤ç° |
| M3-CLI-03 | å›ºå®šå±€é¢ï¼Œä¾æ¬¡æäº¤ 3 æ¬¡åˆæ³•åŠ¨ä½œ | æ¯æ¬¡æç¤ºâ€œå½“å‰æ“ä½œ seat=Xâ€ï¼Œå¹¶ä¸çŠ¶æ€ä¸­çš„ `decision.seat` ä¸€è‡´ |
| M3-CLI-04 | å›ºå®šå±€é¢è¿›å…¥äº¤äº’ä¸€è½® | å±•ç¤ºå…¬å…±æ€ï¼ˆphase/version/turnï¼‰+ å½“å‰ seat `hand`ï¼›å…¶ä»– seat ä¸å±•ç¤ºå®Œæ•´ `hand` |
| M3-CLI-05 | å›ºå®šå±€é¢ï¼Œè·å– legal actions | CLI åˆ—è¡¨é¡ºåºä¸ `get_legal_actions` ä¸€è‡´ï¼Œç´¢å¼•ä» 0 è¿ç»­é€’å¢ |
| M3-CLI-06 | é€‰æ‹© COVERï¼Œå…ˆè¾“å…¥é”™è¯¯å¼ æ•°ï¼Œå†è¾“å…¥æ­£ç¡® `cover_list` | é¦–æ¬¡æç¤ºé”™è¯¯å¹¶é‡è¾“ï¼›ç¬¬äºŒæ¬¡æˆåŠŸæ¨è¿›çŠ¶æ€ |
| M3-CLI-07 | è¾“å…¥è¶Šç•Œ `action_idx`ï¼ˆå¦‚ 99ï¼‰ | æ‰“å° `ENGINE_INVALID_ACTION_INDEX`ï¼ŒçŠ¶æ€ç‰ˆæœ¬ä¸å˜ï¼Œå¯ç»§ç»­é€‰æ‹© |
| M3-CLI-08 | æ¨è¿›åˆ° `settlement` æˆ– `finished` | CLI ç»™å‡ºç»ˆå±€æç¤ºå¹¶é€€å‡ºï¼›è‹¥ `settle` å¯ç”¨åˆ™å¯æ‰§è¡Œç»“ç®—åé€€å‡º |

## 7) TDD æ‰§è¡Œè®°å½•ï¼ˆè¿›è¡Œä¸­ï¼‰

> è¯´æ˜ï¼šå½“å‰å·²å®Œæˆ `M3-UT-01~05`ã€`M3-CB-01~14`ã€`M3-LA-01~22` ä¸ `M3-ACT-01~10`ï¼›CLI æ–°å¢éœ€æ±‚ä¸­ `M3-CLI-01~04` å·²æœ‰çº¢æµ‹è®°å½•ï¼Œ`M3-CLI-05~08` å·²æ‹‰çº¢å¾…è½¬ç»¿ã€‚

| æµ‹è¯•ID | å½“å‰çŠ¶æ€ | TDDé˜¶æ®µ | å¤‡æ³¨ |
|---|---|---|---|
| M3-UT-01 ~ M3-UT-05 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | Redï¼š2026-02-16 é¦–æ¬¡æ‰§è¡Œå¤±è´¥ï¼ˆ`init_game` æœªå®ç°ï¼‰ï¼›Greenï¼š2026-02-16 å®Œæˆ `engine/core.py` çš„ `init_game/apply_action` åæ‰§è¡Œ `pytest engine/tests/test_m3_red_ut_01_05.py -q`ï¼ˆ5 passedï¼‰ |
| M3-CB-01 ~ M3-CB-04 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | Redï¼š2026-02-15 æ‰§è¡Œ `conda run -n XQB pytest engine/tests/test_m3_red_cb_la_01_06.py -q`ï¼ˆç¼ºå¤± `engine.combos`ï¼‰ï¼›Greenï¼š2026-02-16 æ–°å¢ `engine/combos.py` åæ‰§è¡Œ `pytest engine/tests/test_m3_red_cb_la_01_06.py -q` é€šè¿‡ |
| M3-LA-04 ~ M3-LA-06 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | Redï¼š2026-02-15 åŒæ‰¹æ¬¡æ‰§è¡Œï¼ˆç¼ºå¤± `engine.core`ï¼‰ï¼›Greenï¼š2026-02-16 æ–°å¢ `engine/core.py` åæ‰§è¡Œ `pytest engine/tests/test_m3_red_cb_la_01_06.py -q` é€šè¿‡ |
| M3-CB-05 ~ M3-CB-12 | âœ… é€šè¿‡ | Red å·²æ‰§è¡Œï¼ˆæ„å¤–å…¨ç»¿ï¼‰ | 2026-02-16ï¼šå·²æ–°å¢ `engine/tests/test_m3_red_cb_05_12.py` å¹¶æ‰§è¡Œ `pytest engine/tests/test_m3_red_cb_05_12.py -q`ï¼ˆ8 passedï¼‰ï¼›å½“å‰å®ç°å·²æ»¡è¶³ç”¨ä¾‹é¢„æœŸ |
| M3-CB-13 ~ M3-CB-14 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | 2026-02-16ï¼šå·²æ–°å¢ `engine/tests/test_m3_cb_13_14_gou_che_power.py` å¹¶æ‰§è¡Œ `pytest engine/tests/test_m3_cb_13_14_gou_che_power.py -q`ï¼ˆ2 passedï¼‰ |
| M3-LA-01 ~ M3-LA-03, M3-LA-07 ~ M3-LA-12 | âœ… é€šè¿‡ | Red å·²æ‰§è¡Œï¼ˆæ„å¤–å…¨ç»¿ï¼‰ | 2026-02-17ï¼šå·²æ–°å¢ `engine/tests/test_m3_red_la_01_03_07_12.py` å¹¶æ‰§è¡Œ `pytest engine/tests/test_m3_red_la_01_03_07_12.py -q`ï¼ˆ9 passedï¼‰ï¼›å½“å‰å®ç°å·²æ»¡è¶³ç”¨ä¾‹é¢„æœŸ |
| M3-LA-13 ~ M3-LA-22 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | 2026-02-16ï¼šå·²æ–°å¢ `engine/tests/test_m3_la_play_enumeration_13_22.py`ï¼Œæ‰§è¡Œ `pytest engine/tests/test_m3_la_play_enumeration_13_22.py -q`ï¼ˆ10 passedï¼‰ä¸ `pytest engine/tests -q`ï¼ˆ17 passedï¼‰ |
| M3-ACT-01 ~ M3-ACT-07 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | Redï¼š2026-02-17 å·²æ–°å¢ `engine/tests/test_m3_red_act_01_07.py` å¹¶æ‰§è¡Œï¼ˆ`6 passed, 1 failed`ï¼‰ï¼›Greenï¼š2026-02-17 å®Œæˆ `engine/core.py` çš„ `REVEAL/PASS_REVEAL` çŠ¶æ€æ¨è¿›åæ‰§è¡Œ `pytest engine/tests/test_m3_red_act_01_07.py -q`ï¼ˆ7 passedï¼‰ |
| M3-ACT-08 ~ M3-ACT-10 | âœ… é€šè¿‡ | Green å·²å®Œæˆ | Redï¼š2026-02-16 é¦–æ¬¡æ‰§è¡Œå¤±è´¥ï¼ˆ`apply_action` æœªå®ç°ï¼‰ï¼›Greenï¼š2026-02-16 å®Œæˆå›åˆæ”¶å°¾ä¸ `pillar_groups.pillars` æ‹†æŸ±åæ‰§è¡Œ `pytest engine/tests/test_m3_red_act_08_10_pillars.py -q`ï¼ˆ3 passedï¼‰ |
| M3-CLI-01 ~ M3-CLI-04 | ğŸŸ¥ Red å·²æ‰§è¡Œï¼ˆ4 çº¢ï¼‰ | Red å·²æ‰§è¡Œ | 2026-02-17ï¼šå·²æ–°å¢ `engine/tests/test_m3_red_cli_01_04.py` å¹¶æ‰§è¡Œ `pytest engine/tests/test_m3_red_cli_01_04.py -q`ï¼ˆ4 failedï¼‰ï¼›å¤±è´¥åŸå› ä¸ºç¼ºå¤± `engine.cli` æ¨¡å—ä¸çº¦å®šå‡½æ•°ï¼ˆ`build_initial_snapshot / resolve_seed / render_turn_prompt / render_state_view`ï¼‰ |
| M3-CLI-05 ~ M3-CLI-08 | ğŸŸ¥ Red å·²æ‰§è¡Œï¼ˆ4 çº¢ï¼‰ | Red å·²æ‰§è¡Œ | 2026-02-17ï¼šå·²æ–°å¢ `engine/tests/test_m3_red_cli_05_08.py` å¹¶æ‰§è¡Œ `pytest engine/tests/test_m3_red_cli_05_08.py -q`ï¼ˆ4 failedï¼‰ï¼›å¤±è´¥ç‚¹ä¸ºåŠ¨ä½œåˆ—è¡¨æœªæ˜¾å¼å±•ç¤º `action_idx/payload_cards`ã€COVER å¤±è´¥åéœ€é‡æ–°é€‰æ‹© `action_idx`ã€éæ³•ç´¢å¼•æœªä»¥â€œé”™è¯¯ç å‰ç¼€â€è¾“å‡ºã€`settlement` æœªå‘½ä¸­çº¦å®šæç¤ºæ–‡æ¡ˆã€‚ |
