# 产品需求文档（MVP）

## 目标（MVP）
构建一个网页端三人掀棋游戏大厅，支持玩家从登录到完整对局并结算筹码。

## MVP范围
MVP阶段，安全性可以较为基础，对用户的恶意行为可以基本不设防。
### 包含
- 账号系统：创建账号与登录（方式：账号+密码）。
- 大厅：显示房间列表（基础信息：房间编号、人数、状态）。
- 房间：加入房间/退出房间。
- 准备：房间内更改就绪状态，三人全部就绪后开始游戏。
- 对局：实时更新公共状态与私人状态，支持出棋/垫棋/扣棋/掀棋操作。
- 断线重连：服务端未重启时可恢复当前局（内存快照）。
- 结算：单局结束后进行筹码结算；结算后清空全员就绪状态，三人再次就绪后开始下一局。

### 不包含（明确暂不做）
- 额外规则（掀瓷包瓷、第一盘没瓷没扣、抱头、接棋决定先出等）。
- 历史记录/回放（含跨重启的对局恢复）。
- 观战、旁观、聊天。
- 四人玩法与抱头玩家。

## 单局游戏规则（MVP版）
详细规则参见 `XianQi_rules.md`，MVP默认以下约束：
- 固定三人对局，逆时针顺序。
- 使用 24 张棋（去除帅/将、1 炮、2 兵/卒）。
- 仅启用基础规则与基础结算，不启用额外规则。

## 关键流程细化
### 房间与开局
- 房间人数固定为 3。
- 房间编号固定由服务端预设；首位进入者为房主。
- 房间开始条件：三人全部就绪。
- 开局前确定先揭棋/先出棋玩家。MVP阶段采用随机指定，三个人先出棋概率相同。
- 黑棋重发：若开局发牌后任一玩家不拥有士/相，则本次发牌作废，使用当前随机数种子 `+1` 重新发牌；若仍命中黑棋则继续 `+1`，直到无人黑棋后再开始对局。
- MVP 不提供动态增加/解散房间功能。
- 任一玩家强制离开仅移除自身，房间继续存在；若对局进行中则当前对局冷结束，不做结算，筹码保持不变。
- 每局进入结算后，服务端将房间内三名成员 `ready` 全部重置为 `false`；下一局仍通过三人依次点击 ready 触发开局。

### 对局回合与出棋
- 每局开始三人接棋（逆时针）。
- 首位接棋玩家决定是否出棋或扣棋。
- 出棋类型：单张、对子（含狗脚对）、三牛。
- 压制规则与垫棋规则按 `XianQi_rules.md` 执行。
- 一回合结束后，最大组合玩家获得本回合棋子并计算柱数。
- 进入下一回合时由上回合最大组合玩家决定出棋或扣棋。

### 扣棋与掀棋
- 某玩家扣棋后，其他玩家按规则顺序决定是否掀棋（若存在活跃掀棋者，则由其先决定，否则逆时针）。
- 若当前被询问玩家选择不掀棋，则继续询问下一位；若被询问的第一位玩家选择掀棋，ta成为活跃掀棋者，本次掀棋决策立即结束，游戏直接回到扣棋玩家开始出棋，不再询问第三名玩家。在之后的某次扣棋后，如果活跃掀棋者选择放弃掀棋，则ta不再是活跃掀棋者。
- 记录掀棋关系（掀棋方 → 扣棋方），用于结算筹码。

### 结束条件
- 正常结束：扣棋时无人再掀棋，进入结算。
- 提前结束：每次回合收束并更新柱数后，若任一玩家已瓷（>=6柱）或两名玩家已够（>=3柱），直接进入结算。

## 计分与筹码结算（MVP）
按 `XianQi_rules.md` 的基础结算执行：
- 够棋与瓷棋判定（>=3 柱且 <6 柱为够；>=6 柱为瓷）。
- 未够棋玩家向够/瓷玩家支付筹码。
- 掀棋但未够棋时需向扣棋方支付掀棋筹码。
- 已够棋但未瓷时掀棋的特殊结算逻辑同规则。

## 数据与状态（用于实现对齐）
### 公开状态（所有玩家可见）
- 房间信息：房间编号、玩家列表、就绪状态、当前状态（未开始/进行中/结算）。
- 当前回合：当前出棋方、上一手出的棋型与大小、回合序号/手数。
- 结算：每名玩家本局柱数、够/瓷标记、结算明细。

### 私有状态（仅自己可见）
- 手牌列表（含面值/颜色信息）。
- 自己的可行动作提示（可出/可垫/可掀/可扣）。
- 自己已垫棋子的列表或计数（仅自己可见）。

## 待确认（需要你填写）
- 登录方式：账号+密码 / 仅昵称+口令 / 第三方登录？MVP阶段采用账号+密码。
- 房间名与房间密码是否允许？MVP阶段不需要（房间仅用编号）
- 先手判定使用骰子还是接棋？MVP阶段采用随机指定，三个人先出棋概率相同。
- 是否需要回合/操作超时与自动处理？MVP阶段不需要。
- 筹码初始数量与是否可为负？MVP阶段默认每人初始20枚筹码，可为负。
