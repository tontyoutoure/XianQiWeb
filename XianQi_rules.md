# 掀棋规则规范（最小可用版本）

## 1. 文档定位与适用范围
- 本文档是掀棋规则的唯一事实来源。
- 本文档默认适用于三人对局，所有行动顺序均为逆时针。
- 本文档正文仅包含最小可用版本基础规则；额外规则统一放在附录，默认关闭。
- 本文档使用规范词：
  - **必须**：强制要求。
  - **不得**：禁止要求。
  - **可**：允许但非强制。

## 2. 术语定义
- **回合起始玩家**：当前一回合中先做“扣棋/不扣”决策的玩家。
- **回合收束**：同一回合内三名玩家均完成动作后，执行统一处理：确定本回合最大组合玩家、归集本回合棋子、更新柱数，并进入提前终局判定或下一回合流程。回合收束不得等同于单局结束时的筹码结算。
- **扣棋**：回合起始玩家选择不直接进入出棋流程，而先触发“是否掀棋”询问流程。
- **掀棋**：被询问玩家同意继续本局并对当前扣棋方建立一次掀扣关系。
- **活跃掀棋者**：一局中最近一次成功掀棋且尚未命中清零条件的玩家。清零条件见 5.2 与 5.3。
- **掀扣关系**：一条“掀棋方 -> 扣棋方”的记录，并附带“掀棋当刻是否已够棋”。
- **柱数**：玩家已赢得棋子的柱数；每 3 张棋子记为 1 柱。
- **够棋**：玩家柱数大于等于 3 且小于 6。
- **瓷棋**：玩家柱数大于等于 6。
- **黑棋**：开局发牌后，任一玩家手中无士且无相。

## 3. 牌组、组合与大小

### 3.1 牌组构成
使用中国象棋棋子。由完整棋组移除以下棋子后形成 24 张牌堆：
- 双方帅/将各 1 张（共 2 张）；
- 双方炮各移除 1 张中的 1 张（即每方仅保留 1 炮）；
- 双方兵/卒各移除 2 张（即每方保留 3 兵/卒）。

牌名约定：
- 炮在本规则中称为**狗**；
- 兵/卒在本规则中称为**牛**。

### 3.2 合法出棋组合
玩家在“出棋”动作中，必须从以下组合中选择其一：
1. 单张；
2. 对子（两张完全相同，或红狗 + 黑狗组成的“狗脚对”）；
3. 三张（仅允许三牛）。

### 3.3 组合大小比较

#### 3.3.1 单张大小（从大到小）
士 > 相 > 马 > 车 = 同色狗 > 牛；同类中红 > 黑。

#### 3.3.2 对子大小（从大到小）
狗脚对 = 红士对 > 黑士对 > 其余对子按对应单张序列比较。

#### 3.3.3 三张大小
红三牛 > 黑三牛。

#### 3.3.4 压制判定
- 后手组合必须“严格大于”当前回合最大组合，才算压制成功。
- 与当前回合最大组合“大小相同”不得视为可压制。

## 4. 对局状态与不变量

### 4.1 状态阶段
- **开局阶段**：洗牌、发牌、判定先手、黑棋检测。
- **扣掀决策阶段**：回合起始玩家先做扣棋/不扣；若扣棋则询问其他玩家是否掀棋。
- **回合进行阶段**：本回合三名玩家依次执行出棋或垫棋。
- **结算阶段**：按柱数与掀扣关系计算筹码增减。
- **结束阶段**：本局完成，等待是否开始下一局。

### 4.2 关键状态字段（概念）
- 当前行动位；
- 当前回合张数（1/2/3）；
- 当前回合行动记录（3 人各 1 次）；
- 当前回合最大组合；
- 当前扣棋方；
- 当前活跃掀棋者（可为空）；
- 待询问顺序（仅扣掀决策阶段使用）；
- 掀扣关系列表（含“掀棋当刻是否已够棋”）；
- 各玩家柱数。

### 4.3 不变量
- 每回合必须由三名玩家各行动一次后才进入回合收束。
- 当前回合张数一旦由首手确定，本回合内不得改变。
- 扣掀决策阶段中，当前被询问玩家不得执行出棋或垫棋。
- 命中首个“掀棋”后，本次询问必须立即结束，不得继续询问剩余玩家。
- 当玩家存在可压制组合时，必须压制，不得垫棋。
- 垫棋必须与当前回合张数一致，且垫棋牌面朝下，其他玩家不得翻看。

## 5. 流程规则（状态转移口径）

### 5.1 开局与黑棋判定
| 前置条件 | 玩家动作 | 状态更新 | 下一阶段 |
|---|---|---|---|
| 新局开始 | 无 | 洗牌并发牌；确定首位回合起始玩家 | 开局阶段 |
| 发牌完成 | 无 | 若任一玩家黑棋，立即标记本局终止 | 结算阶段 |
| 发牌完成且无人黑棋 | 首位回合起始玩家进入决策 | 初始化本回合状态（空行动记录、无最大组合） | 扣掀决策阶段 |

### 5.2 扣棋与掀棋

#### 5.2.1 触发与入口
| 前置条件 | 玩家动作 | 状态更新 | 下一阶段 |
|---|---|---|---|
| 回合起始玩家获得决策权 | 选择不扣 | 清空扣掀决策临时数据，保留当前起始玩家为首手出棋方 | 回合进行阶段 |
| 回合起始玩家获得决策权 | 选择扣棋 | 记录当前扣棋方，并生成待询问顺序 | 扣掀决策阶段 |

- 若回合起始玩家在“选择扣棋”时等于当前活跃掀棋者，必须先将活跃掀棋者清零，再生成待询问顺序。
- 上述清零后，本次待询问顺序按“无活跃掀棋者”口径生成（仅包含另外两名非扣棋玩家）。

#### 5.2.2 待询问顺序生成
- 若存在活跃掀棋者，则待询问顺序必须以该玩家为第一位，另一名非扣棋玩家为第二位。
- 若不存在活跃掀棋者，则待询问顺序必须从扣棋方下一位开始，按逆时针排满两位。

#### 5.2.3 询问单步推进
| 前置条件 | 当前被询问玩家动作 | 状态更新 | 下一阶段 |
|---|---|---|---|
| 待询问顺序非空 | 不掀棋 | 若该玩家为活跃掀棋者，则清空活跃掀棋者；弹出该玩家 | 若仍有待询问玩家，留在扣掀决策阶段；否则进入结算阶段 |
| 待询问顺序非空 | 掀棋 | 追加一条掀扣关系（掀棋方->扣棋方，记录掀棋当刻是否已够棋）；将活跃掀棋者设为该玩家；清空待询问顺序；重置本回合为首手前状态；当前行动位切回扣棋方 | 回合进行阶段 |

#### 5.2.4 扣棋/掀棋终止规则
- 扣掀决策中，首个掀棋一旦发生，本次询问必须立即终止并切回扣棋方首手出棋。
- 扣掀决策中，若两名被询问玩家均不掀棋，本局必须直接进入结算。

### 5.3 回合进行（出棋、压制、垫棋、回合收束）
| 前置条件 | 玩家动作 | 状态更新 | 下一阶段 |
|---|---|---|---|
| 当前回合尚无首手 | 出棋 | 本回合张数由首手组合确定；记录首手为当前回合最大组合 | 回合进行阶段 |
| 当前回合已有最大组合且存在可压制组合 | 出棋（压制） | 记录该动作并更新当前回合最大组合 | 回合进行阶段 |
| 当前回合已有最大组合且不存在可压制组合 | 垫棋 | 记录垫棋（朝下，不参与最大组合比较） | 回合进行阶段 |
| 三名玩家均已完成本回合动作 | 无 | 执行回合收束：本回合最大组合玩家获得本回合全部棋子；按“每 3 张 1 柱”更新柱数（等价于本回合赢家柱数增加“本回合张数”）；下一回合起始玩家设为本回合最大组合玩家 | 进入提前终局判定 |

- 回合收束并更新柱数后，若当前活跃掀棋者在回合收束前柱数小于 3 且回合收束后柱数大于等于 3，必须立即清零活跃掀棋者。

### 5.4 提前终局判定
每次回合收束并更新柱数后，必须立即执行以下判定：
1. 若任一玩家柱数大于等于 6（瓷棋），本局进入结算阶段；
2. 否则，若柱数大于等于 3 的玩家数量大于等于 2（两家够），本局进入结算阶段；
3. 否则，进入下一回合扣掀决策阶段。

## 6. 结算规则

### 6.1 身份判定
- 玩家柱数在 [3, 6) 区间内，判定为够棋。
- 玩家柱数大于等于 6，判定为瓷棋。

### 6.2 黑棋结算
黑棋导致的本局终止，三名玩家筹码增减均为 0。

### 6.3 基础筹码结算
对每一名未够棋玩家，必须执行：
1. 向每一名够棋玩家支付 1 枚筹码；
2. 向每一名瓷棋玩家支付 3 枚筹码。

### 6.4 掀棋筹码结算
对每一条掀扣关系（掀棋方 -> 扣棋方），按下列规则独立判定：
- 若“掀棋当刻未够棋”且“结算时仍未够棋”，则掀棋方向该扣棋方支付 1 枚筹码；
- 其余情况不产生该条掀棋筹码支付。

### 6.5 特殊条款：已够时掀棋且最终未瓷
若某玩家在至少一次掀棋当刻已够棋，且结算时未达到瓷棋，则该玩家本局不得获得“够棋筹码”（即其他未够棋玩家无需向其支付每人 1 枚的够棋款项）。

### 6.6 结算守恒
本局所有玩家筹码增减代数和必须为 0。

## 附录一：额外规则（默认关闭）
以下规则不属于最小可用版本基础流程，默认关闭；仅在开局前全体同意启用时生效。

1. **掀瓷包瓷**：若玩家甲在玩家乙掀棋后的一回合内达成瓷棋，则玩家乙承担甲全部瓷棋筹码，其他玩家不再承担甲的瓷棋筹码。
2. **第一盘没瓷没扣**：第一局中，所有玩家在未够棋时不得扣棋；且瓷棋筹码按够棋口径计算。
3. **抱头**：四人扩展玩法中，每局随机一名抱头玩家，抱头玩家与其右手玩家输赢绑定，且瓷棋结算单位改为 4 枚。
4. **接棋决定先出**：使用抽牌结果决定起始顺序的扩展规则，具体映射关系由开局前约定。
